<dc-spinner spinner-mode="cmcc.spinnerOptions.mode" show="cmcc.spinnerOptions.showSpinner"></dc-spinner>
<md-content layout-padding>
    <md-tabs md-dynamic-height md-border-bottom>
        <md-tab label="{{cmcc.tabLabels.settings}}">
            <form name="mongoForm">
                <md-content class="md-padding">
                    <md-checkbox ng-model="cmcc.connection.isConnected" aria-label="Automatic startup after Creation"
                                 ng-true-value="true" ng-false-value="false"
                                 class="md-warn md-align-top-left" flex>
                        <span class="ipsum" message-key="dc_databaseConnector.label.connection.enableConnection"></span>
                    </md-checkbox>

                    <md-button class="md-fab md-mini md-success pull-right"
                               ng-click="cmcc.testMongoConnection()"
                               ng-disabled="mongoForm.$invalid || mongoAdvancedForm.$invalid">
                        <i class="fa fa-lg fa-check-circle-o"></i>
                        <md-tooltip class="noToolTipAnimation"
                                    md-direction="top"
                                    md-delay="500">
                            <span message-key="dc_databaseConnector.label.connection.testConnection"></span>
                        </md-tooltip>
                    </md-button>
                    <md-input-container class="md-block" flex-gt-sm="1">
                        <label message-key="dc_databaseConnector.label.host"></label>
                        <input title="host" required ng-minlength="4" md-maxlength="15" name="host"
                               ng-model="cmcc.connection.host">
                        <div ng-messages="mongoForm.host.$error">
                            <div ng-message-exp="validationName"
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.host"
                                 ng-class="{'showErrorMessages': mongoForm.host.$invalid && mongoForm.host.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>

                    <md-input-container class="md-block">
                        <label message-key="dc_databaseConnector.label.port"></label>
                        <input title="port" md-maxlength="5" ng-pattern="/[0-9]*/" name="port"
                               ng-model="cmcc.connection.port" length-parser length-parser-max="5" range-parser
                               range-max-value="65535">
                        <div ng-messages="mongoForm.port.$error">
                            <div ng-message-exp="validationName"
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.port"
                                 ng-class="{'showErrorMessages': mongoForm.port.$invalid && mongoForm.port.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>

                    <md-input-container class="md-block">
                        <label message-key="dc_databaseConnector.label.connection.id"></label>
                        <input title="Connection Name" md-maxlength="30" name="id" required
                               ng-pattern="/^[a-zA-Z0-9]+$/"
                               ng-model="cmcc.connection.id" original-value="{{cmcc.connection.oldId}}"
                               connection-id-validator="mongodb">
                        <div ng-messages="mongoForm.id.$error">
                            <div ng-message-exp="validationName"
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.id"
                                 ng-class="{'showErrorMessages': mongoForm.id.$invalid && mongoForm.id.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>

                    <md-input-container class="md-block">
                        <label message-key="dc_databaseConnector.label.connection.dbName"></label>
                        <input title="Database Name" md-maxlength="30" required ng-pattern="/^[a-zA-Z0-9_]+$/"
                               name="dbName"
                               ng-model="cmcc.connection.dbName">
                        <div ng-messages="mongoForm.dbName.$error">
                            <div ng-message-exp="validationName"
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.dbName"
                                 ng-class="{'showErrorMessages': mongoForm.dbName.$invalid && mongoForm.dbName.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>

                    <md-input-container class="md-block">
                        <label message-key="dc_databaseConnector.label.user"></label>
                        <input title="User" name="user" ng-minlength="4" md-maxlength="30"
                               ng-model="cmcc.connection.user"
                               ng-pattern="/^[a-zA-Z0-9_-]*$/"
                               ng-change="cmcc.updateIsEmpty('user');">
                        <div ng-messages="mongoForm.user.$error">
                            <div ng-message-exp="validationName"
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.user"
                                 ng-class="{'showErrorMessages': mongoForm.user.$invalid && mongoForm.user.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>

                    <md-input-container class="md-block" ng-if="!cmcc.isEmpty.user">
                        <label message-key="dc_databaseConnector.label.password"></label>
                        <input title="Password" type="password" name="password" ng-model="cmcc.connection.password"
                               ng-change="cmcc.updateIsEmpty('password');">
                    </md-input-container>

                    <md-input-container class="md-block" ng-if="!cmcc.isEmpty.password && !cmcc.isEmpty.user">
                        <label message-key="dc_databaseConnector.label.modal.mongo.authenticationDatabase"></label>
                        <input title="Authentication Database" required name="authDb"
                               ng-model="cmcc.connection.authDb">
                        <div ng-messages="mongoForm.authDb.$error">
                            <div ng-message-exp="validationName"
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.authDb"
                                 ng-class="{'showErrorMessages': mongoForm.authDb.$invalid && mongoForm.authDb.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>
                </md-content>
            </form>
        </md-tab>

        <md-tab label="{{cmcc.tabLabels.advancedSettings}}">
            <md-content class="md-padding">
                <form name="mongoAdvancedForm">

                    <md-subheader class=" md-no-sticky">
                        <span message-key="dc_databaseConnector.label.modal.mongo.replicaSet"></span>
                        <md-checkbox class="pull-right"
                                     ng-model="cmcc.isReplicaSet"
                                     ng-true-value="true"
                                     ng-false-value="false"
                                     ng-change="cmcc.updateReplicaSetOptions()">
                        </md-checkbox>
                    </md-subheader>
                    <div ng-if="cmcc.isReplicaSet">
                        <md-input-container class="md-block col-md-offset-2">
                            <label message-key="dc_databaseConnector.label.name"></label>
                            <input title="replicaSetName" required
                                   name="replicaSetName"
                                   ng-pattern="/^[a-zA-Z0-9_]+$/"
                                   ng-model="cmcc.connection.options.repl.replicaSet">
                            <div ng-messages="mongoAdvancedForm.replicaSetName.$error">
                                <div ng-message-exp='validationName'
                                     ng-repeat="(validationName, validationMessage) in cmcc.validations.replicaSet.name"
                                     ng-class="{'showErrorMessages': mongoAdvancedForm.replicaSetName.$invalid && mongoAdvancedForm.replicaSetName.$touched}"
                                     ng-init="cmcc.initReplicaMember()">
                                    {{validationMessage}}
                                </div>
                            </div>
                        </md-input-container>
                        <md-list>
                            <md-list-item ng-repeat="member in cmcc.connection.options.repl.members track by $index "
                                          layout-margin layout-padding layout-fill layout-wrap="" class="box-wrap2">
                                <md-input-container class="md-block" layout="flex">
                                    <label message-key="dc_databaseConnector.label.host"></label>
                                    <input title="replicaSetHost" class="md-primary" required
                                           name="replicaSetHost_{{$index}}"
                                           ng-model="member.host">
                                    <div ng-messages="mongoAdvancedForm['replicaSetHost_' + $index].$error">
                                        <div ng-message-exp='validationName'
                                             ng-repeat="(validationName, validationMessage) in cmcc.validations.members.host"
                                             ng-class="{'showErrorMessages': mongoAdvancedForm['replicaSetHost_' + $index].$invalid && mongoAdvancedForm['replicaSetHost_' + $index].$touched}">
                                            {{validationMessage}}
                                        </div>
                                    </div>
                                </md-input-container>
                                :
                                <md-input-container class="md-block" layout="flex">
                                    <label message-key="dc_databaseConnector.label.port"></label>
                                    <input title="replicaSetPort" class="md-primary"
                                           name="replicaSetPort_{{$index}}"
                                           ng-pattern="/^[0-9]*$/"
                                           ng-model="member.port " length-parser length-parser-max="5" range-parser
                                           range-max-value="65535">
                                    <div ng-messages="mongoAdvancedForm['replicaSetPort_'+ $index].$error">
                                        <div ng-message-exp='validationName'
                                             ng-repeat="(validationName, validationMessage) in cmcc.validations.members.port"
                                             ng-class="{'showErrorMessages': mongoAdvancedForm['replicaSetPort_' + $index].$invalid && mongoAdvancedForm['replicaSetPort_' + $index].$touched}">
                                            {{validationMessage}}
                                        </div>
                                    </div>
                                </md-input-container>
                                <md-icon class="md-secondary"
                                         title="Delete connection"
                                         ng-click="cmcc.removeReplicaMember($index)">
                                    <i class="fa fa-trash-o"></i>
                                </md-icon>
                            </md-list-item>
                            <md-list-item>
                                <md-icon class="md-secondary"
                                         title="Create new Mongo connection"
                                         ng-click="cmcc.addReplicaMember()">
                                    <i class="fa fa-plus"
                                       title=" Add  Replica member"></i>
                                </md-icon>
                            </md-list-item>
                        </md-list>
                    </div>
                    <md-divider></md-divider>

                    <md-subheader class="md-no-sticky">
                        <span message-key="dc_databaseConnector.label.modal.connectionSettings"></span>
                    </md-subheader>

                    <md-input-container class="md-block col-md-offset-2">
                        <label message-key="dc_databaseConnector.label.modal.mongo.connectTimeout"></label>
                        <input title="Connect Timeout" name="connectTimeoutMS" range-parser
                               ng-pattern="/^[0-9]*$/"
                               ng-model="cmcc.connection.options.conn.connectTimeoutMS">
                        <div ng-messages="mongoAdvancedForm.connectTimeoutMS.$error">
                            <div ng-message-exp='validationName'
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.connectTimeoutMS"
                                 ng-class="{'showErrorMessages': mongoAdvancedForm.connectTimeoutMS.$invalid && mongoAdvancedForm.connectTimeoutMS.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>
                    <md-input-container class="md-block col-md-offset-2">
                        <label message-key="dc_databaseConnector.label.modal.mongo.socketTimeout"></label>
                        <input title="Socket Timeout" name="socketTimeoutMS" range-parser
                               ng-pattern="/^[0-9]*$/"
                               ng-model="cmcc.connection.options.conn.socketTimeoutMS">
                        <div ng-messages="mongoAdvancedForm.socketTimeoutMS.$error">
                            <div ng-message-exp='validationName'
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.socketTimeoutMS"
                                 ng-class="{'showErrorMessages': mongoAdvancedForm.socketTimeoutMS.$invalid && mongoAdvancedForm.socketTimeoutMS.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>

                    </md-input-container>
                    <md-input-container class="md-block col-md-offset-2">
                        <label message-key="dc_databaseConnector.label.modal.mongo.writeConcern"></label>
                        <md-select ng-model="cmcc.connection.writeConcern">
                            <md-option ng-repeat="writeConcern in cmcc.writeConcernOptions" value="{{writeConcern}}">
                                {{writeConcern}}
                            </md-option>
                        </md-select>
                    </md-input-container>
                    <md-divider></md-divider>

                    <md-subheader class="md-no-sticky"><span message-key="dc_databaseConnector.label.modal.mongo.connectionPoolSettings"></span>
                    </md-subheader>

                    <md-input-container class="md-block col-md-offset-2">
                        <label message-key="dc_databaseConnector.label.modal.mongo.maxPoolSize"></label>
                        <input title="Max Pool Size" name="maxPoolSize" range-parser
                               ng-pattern="/^[0-9]*$/"
                               ng-model="cmcc.connection.options.connPool.maxPoolSize">
                        <div ng-messages="mongoAdvancedForm.maxPoolSize.$error">
                            <div ng-message-exp='validationName'
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.maxPoolSize"
                                 ng-class="{'showErrorMessages': mongoAdvancedForm.maxPoolSize.$invalid && mongoAdvancedForm.maxPoolSize.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>
                    <md-input-container class="md-block col-md-offset-2">
                        <label message-key="dc_databaseConnector.label.modal.mongo.minPoolSize"></label>
                        <input title="Min Pool Size" name="minPoolSize" range-parser
                               ng-pattern="/^[0-9]*$/"
                               ng-model="cmcc.connection.options.connPool.minPoolSize">
                        <div ng-messages="mongoAdvancedForm.minPoolSize.$error">
                            <div ng-message-exp='validationName'
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.minPoolSize"
                                 ng-class="{'showErrorMessages': mongoAdvancedForm.minPoolSize.$invalid && mongoAdvancedForm.minPoolSize.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>
                    <md-input-container class="md-block col-md-offset-2">
                        <label message-key="dc_databaseConnector.label.modal.mongo.waitQueueTimeout"></label>
                        <input title="Wait Queue Timeout" name="waitQueueTimeoutMS" range-parser
                               ng-pattern="/^[0-9]*$/"
                               ng-model="cmcc.connection.options.connPool.waitQueueTimeoutMS">
                        <div ng-messages="mongoAdvancedForm.waitQueueTimeoutMS.$error">
                            <div ng-message-exp='validationName'
                                 ng-repeat="(validationName, validationMessage) in cmcc.validations.waitQueueTimeoutMS"
                                 ng-class="{'showErrorMessages': mongoAdvancedForm.waitQueueTimeoutMS.$invalid && mongoAdvancedForm.waitQueueTimeoutMS.$touched}">
                                {{validationMessage}}
                            </div>
                        </div>
                    </md-input-container>
                </form>
            </md-content>
        </md-tab>
    </md-tabs>
    <md-button ng-if="cmcc.mode=='create'"
               class="md-raised md-primary pull-right"
               ng-click="cmcc.createMongoConnection()"
               ng-disabled="mongoForm.$invalid || mongoAdvancedForm.$invalid"
               message-key="dc_databaseConnector.label.create">
    </md-button>
    <md-button ng-if="cmcc.mode=='edit'"
               class="md-raised md-primary pull-right"
               ng-click="cmcc.editMongoConnection()"
               ng-disabled="mongoForm.$invalid || mongoAdvancedForm.$invalid"
               message-key="dc_databaseConnector.label.update">
    </md-button>
    <md-button class="md-raised md-primary pull-right"
               ng-disabled="mongoForm.$invalid || mongoAdvancedForm.$invalid"
               ng-if="cmcc.mode=='import-edit'"
               ng-click="cmcc.updateImportedConnection()"
               message-key="dc_databaseConnector.label.ok">
    </md-button>
    <md-button class="md-raised md-primary pull-right"
               ng-click="cmcc.cancel()">
        <span ng-if="cmcc.mode=='edit' || cmcc.mode=='create'"
              message-key="dc_databaseConnector.label.back"></span>
        <span ng-if="cmcc.mode=='import-edit'"
              message-key="dc_databaseConnector.label.cancel"></span>
    </md-button>
</md-content>

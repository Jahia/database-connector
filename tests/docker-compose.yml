version: '3.6'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.2
    environment:
      - discovery.type=single-node
      - cluster.name=jahia-cluster
    container_name: elasticsearch
    ports:
      - 9200:9200
    extra_hosts:
      - jahia:127.0.0.1
  jahia:
    image: jahia/jahia-private:snapshot
    container_name: jahia
    ports:
      - 8080:8080
    extra_hosts:
      - jahia:127.0.0.1
    depends_on:
      - elasticsearch
  # Cypress container
  cypress:
    # the Docker image to use from https://github.com/cypress-io/cypress-docker-images
    # image: "cypress/included:4.7.0"
    build: tests
    depends_on:
      - jahia
    environment:
      # pass base url to test pointing at the web application
      - CYPRESS_baseUrl=http://jahia:8080
      - NEXUS_USERNAME=${NEXUS_USERNAME}
      - NEXUS_PASSWORD=${NEXUS_PASSWORD}
      - MANIFEST=${MANIFEST}
      - CYPRESS_screenshotsFolder=/results/${TAG}/screenshots
      - CYPRESS_videosFolder=/results/${TAG}/videos
    volumes: 
      - type: bind
        source: ./results
        target: /results
    # share the current folder as volume to avoid copying
    # working_dir: /tmp
    # volumes:
    #   - ./:/tmp
    networks:
      - stack
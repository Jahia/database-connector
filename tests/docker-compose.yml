version: '3.3'
services:
  elasticsearch:
    image: "docker.elastic.co/elasticsearch/elasticsearch:${ELASTICSEARCH_VERSION}"
    environment:
      - discovery.type=single-node
      - cluster.name=jahia-cluster
    container_name: elasticsearch
    ports:
      - "9200:9200"
    extra_hosts:
      - jahia:127.0.0.1
  jahia:
    image: "jahia/${JAHIA_VERSION}"
    container_name: jahia
    environment:
      - jahia_cfg_karaf_remoteShellHost=0.0.0.0
    ports:
      - "8080:8080"
    extra_hosts:
      - jahia:127.0.0.1
    depends_on:
      - elasticsearch
  # Cypress container
  cypress:
    build: .
    container_name: e2e-tests
    depends_on:
      - jahia
    environment:
      # pass base url to test pointing at the web application
      - JAHIA_HOST=jahia
      - JAHIA_PORT=8080
      - CYPRESS_baseUrl=http://jahia:8080
      - NEXUS_USERNAME=${NEXUS_USERNAME}
      - NEXUS_PASSWORD=${NEXUS_PASSWORD}
      - MANIFEST=${MANIFEST}
      - CYPRESS_screenshotsFolder=results/screenshots
      - CYPRESS_videosFolder=results/videos
    volumes: 
      - type: bind
        source: ./results
        target: /tmp/results